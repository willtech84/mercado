<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#07101f" />
  <title>Lista de Compras ‚Ä¢ Stable 1.2.4.4.3</title>
  <style>
    :root{
      --bg:#07101f; --card:#0e1a33; --text:#e5e7eb; --muted:#9aa8c2;
      --line:rgba(154,168,194,.18); --acc:#22c55e; --acc2:#60a5fa;
      --danger:#ef4444; --warn:#f59e0b; --radius:18px; --shadow:0 14px 36px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --safeB: env(safe-area-inset-bottom, 0px); --safeT: env(safe-area-inset-top, 0px);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(900px 600px at 20% -10%, rgba(96,165,250,.22), transparent),
        radial-gradient(900px 600px at 100% 0%, rgba(34,197,94,.16), transparent),
        var(--bg);
      padding-bottom: calc(108px + var(--safeB));
      -webkit-tap-highlight-color: transparent;
    }
    header{
      position:sticky; top:0; z-index:30;
      padding: calc(12px + var(--safeT)) 14px 10px;
      backdrop-filter: blur(10px);
      background:linear-gradient(to bottom, rgba(7,16,31,.92), rgba(7,16,31,.62));
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex; align-items:flex-start; gap:10px; justify-content:space-between;}
    .leftHead{display:flex; gap:10px; align-items:center; min-width:0;}
    .logo{width:40px; height:40px; border-radius:14px; background:linear-gradient(135deg, rgba(34,197,94,.95), rgba(96,165,250,.95)); box-shadow:0 14px 28px rgba(34,197,94,.10), 0 14px 28px rgba(96,165,250,.10);}
    .title{display:flex; flex-direction:column; gap:2px; min-width:0;}
    .title h1{margin:0; font-size:14px; letter-spacing:.2px}
    .title .sub{margin:0; font-size:12px; color:var(--muted)}
    .chips{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .chip{font-size:11px; padding:7px 9px; border-radius:999px; border:1px solid var(--line); background:rgba(14,26,51,.65); color:var(--muted); white-space:nowrap;}
    .chip.ok{border-color:rgba(34,197,94,.35); color:#bbf7d0}
    .wrap{max-width:980px; margin:0 auto; padding:12px;}
    .card{background:linear-gradient(180deg, rgba(14,26,51,.92), rgba(14,26,51,.74)); border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:14px;}
    .card h2{margin:0 0 10px; font-size:13px; letter-spacing:.2px}
    .muted{color:var(--muted); font-size:12px; line-height:1.35}
    .tiny{font-size:11px; color:var(--muted)}
    .sep{height:1px; background:var(--line); margin:12px 0}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .field{display:flex; flex-direction:column; gap:6px; flex:1; min-width:150px}
    label{font-size:12px; color:var(--muted)}
    input, textarea{border:1px solid var(--line); background:rgba(7,16,31,.55); color:var(--text); padding:12px 12px; border-radius:14px; outline:none; font-size:15px;}
    textarea{min-height:130px; font-family:var(--mono); font-size:12px}
    .btns{display:flex; gap:8px; flex-wrap:wrap}
    button{border:1px solid var(--line); background:rgba(7,16,31,.55); color:var(--text); padding:12px 12px; border-radius:14px; cursor:pointer; font-size:14px; min-height:44px;}
    button.primary{border-color:rgba(34,197,94,.35); background:linear-gradient(135deg, rgba(34,197,94,.20), rgba(96,165,250,.16));}
    button.danger{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12);}
    button.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10);}
    button.small{padding:8px 10px; min-height:38px; font-size:12px}
    .list{display:flex; flex-direction:column; gap:10px;}
    .item{display:flex; gap:10px; align-items:flex-start; border:1px solid var(--line); background:rgba(7,16,31,.40); padding:12px; border-radius:16px;}
    .grow{flex:1; min-width:0}
    .name{font-weight:650; font-size:14px; word-break:break-word}
    .meta{font-size:12px; color:var(--muted); margin-top:3px}
    .pill{font-family:var(--mono); font-size:12px; padding:6px 9px; border-radius:999px; border:1px solid var(--line); background:rgba(14,26,51,.55); white-space:nowrap;}
    .price{color:#bbf7d0}
    .stickyTotal{position:sticky; bottom: 126px; z-index:20; margin-top:12px; background:linear-gradient(180deg, rgba(14,26,51,.92), rgba(14,26,51,.84)); border:1px solid var(--line); border-radius:16px; padding:12px; box-shadow:var(--shadow);}
    .kpi{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .kpi .big{font-family:var(--mono); font-size:20px; letter-spacing:.2px}
    .kpi .small{font-size:11px; color:var(--muted)}
    .bottomNav{position:fixed; left:0; right:0; bottom:0; z-index:40; padding:10px 10px calc(10px + var(--safeB)); backdrop-filter: blur(10px); background:linear-gradient(to top, rgba(7,16,31,.92), rgba(7,16,31,.62)); border-top:1px solid var(--line);}
    .navRow{max-width:980px; margin:0 auto; display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;}
    .navBtn{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; padding:10px 10px; border-radius:16px; border:1px solid var(--line); background:rgba(14,26,51,.55); min-height:56px; cursor:pointer; user-select:none; text-align:center; font-size:12px; color:var(--muted);}
    .navBtn.active{color:var(--text); border-color:rgba(34,197,94,.35); box-shadow:0 0 0 3px rgba(34,197,94,.10); background:rgba(14,26,51,.82);}
    .toast{position:fixed; left:12px; right:12px; bottom: calc(96px + var(--safeB)); max-width:980px; margin:0 auto; z-index:60; background:rgba(14,26,51,.92); border:1px solid var(--line); border-radius:16px; padding:10px 12px; box-shadow:var(--shadow); display:none;}
    .toast.show{display:block}
    .toast b{color:#bbf7d0}
    details{border:1px solid var(--line); background:rgba(7,16,31,.35); padding:10px 12px; border-radius:16px;}
    summary{cursor:pointer; color:var(--text); font-weight:650}
    .grid2{display:grid; grid-template-columns: 1fr; gap:10px;}
    @media (min-width:720px){ .grid2{grid-template-columns: 1fr 1fr;} }
    .toggleRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .switch{display:flex; gap:8px; align-items:center; font-size:12px; color:var(--muted)}
    .switch input{width:18px; height:18px}
    .seg{display:flex; gap:8px; flex-wrap:wrap}
    .seg button.active{border-color:rgba(34,197,94,.35); box-shadow:0 0 0 3px rgba(34,197,94,.10);}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="leftHead">
      <div class="logo"></div>
      <div class="title">
        <h1>Lista de Compras ‚Ä¢ Stable 1.2.4.4.3</h1>
        <p class="sub">Hist√≥rico por mercado + atualizar cat√°logo + export CSV + backup/restore.</p>
      </div>
    </div>
    <div class="chips">
      <div class="chip ok" id="chipJS">JS: OK</div>
      <div class="chip" id="chipCatalogo">Cat√°logo: 0</div>
      <div class="chip" id="chipItens">Itens: 0</div>
      <div class="chip" id="chipCompras">Compras: 0</div>
      <div class="chip" id="chipAuto">Auto-soma: ON</div>
    </div>
  </div>
</header>

<div class="wrap">
  <main id="view-mercado">
    <section class="card">
      <h2>Modo Mercado</h2>
      <div class="row">
        <div class="field">
          <label>Data</label>
          <input id="buyDate" type="date"/>
        </div>
        <div class="field">
          <label>Estabelecimento</label>
          <input id="buyStore" placeholder="Ex.: Mercado X, Atacad√£o..." />
        </div>
      </div>

      <div class="sep"></div>

      <div class="field">
        <label>Buscar produto (toque para adicionar)</label>
        <input id="searchCatalog" placeholder="Digite: arroz, leite, sab√£o..." />
        <div class="list" id="matchBox"></div>
        <div class="muted">Toque no resultado (ou no bot√£o +Add): entra na lista.</div>
      <div class="sep"></div>
      <h2>Cadastrar produto (r√°pido)</h2>
      <div class="muted">Se n√£o existir no cat√°logo, cadastre aqui. Opcional: j√° adicionar na lista.</div>
      <div class="row">
        <div class="field">
          <label>Produto</label>
          <input id="quickName" placeholder="Ex.: Caf√© 500g" />
        </div>
        <div class="field">
          <label>Valor (unit√°rio)</label>
          <input id="quickPrice" inputmode="decimal" placeholder="Ex.: 12,90" />
        </div>
      </div>
      <div class="btns">
        <button type="button" class="primary" id="btnQuickAddCatalog">Cadastrar no cat√°logo</button>
        <button type="button" id="btnQuickAddList">Cadastrar e adicionar na lista</button>
      </div>

      </div>

      <div class="sep"></div>

      <div class="toggleRow">
        <div class="switch">
          <input id="toggleUpdateCatalog" type="checkbox" />
          <span>Ao editar pre√ßo, <b>atualizar cat√°logo</b> (opcional)</span>
        </div>
      </div>

      <div class="sep"></div>

      <h2>Sua lista</h2>
      <div class="muted">Marque o checkbox para somar. Toque no nome do item para ver hist√≥rico de pre√ßo.</div>
      <div class="list" id="currentList"></div>

      <div class="stickyTotal">
        <div class="kpi">
          <div>
            <div class="small">Total atual</div>
            <div class="big" id="totalNow">R$ 0,00</div>
            <div class="small" id="totalSmall">‚Äî</div>
          </div>
          <div class="btns">
            <button type="button" id="btnToggleAuto">Auto-soma</button>
            <button type="button" class="primary" id="btnFinalizar">Finalizar</button>
            <button type="button" class="danger" id="btnLimpar">Limpar</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <h2>Hist√≥rico de pre√ßo do produto</h2>
      <div class="muted" id="phTitle">Toque no nome do item da lista para ver m√≠nimo/m√°ximo e √∫ltimos registros.</div>
      <div class="sep"></div>
      <div class="seg">
        <button type="button" class="small" id="btnHistAll">Geral</button>
        <button type="button" class="small" id="btnHistStore">S√≥ este mercado</button>
      </div>
      <div class="sep"></div>
      <div class="list" id="phBox"></div>
    </section>
  </main>

  <main id="view-catalogo" hidden>
    <section class="card">
      <h2>Cat√°logo</h2>
      <div class="muted">Cat√°logo carregado do CSV. Voc√™ pode importar outro CSV (produto;valor_unitario).</div>
      <div class="sep"></div>
      <div class="row">
        <div class="field">
          <label>Buscar</label>
          <input id="catSearch" placeholder="Buscar no cat√°logo..." />
        </div>
        <div class="field">
          <label>Importar CSV</label>
          <input id="csvImport" type="file" accept=".csv,text/csv" />
        </div>
      </div>
      <div class="sep"></div>
      <div class="list" id="catalogList"></div>
    </section>
  </main>

  <main id="view-historico" hidden>
    <section class="card">
      <h2>Hist√≥rico de compras</h2>
      <div class="muted">Compras finalizadas (data, estabelecimento, total e itens).</div>
      <div class="sep"></div>
      <div class="list" id="purchasesList"></div>
    </section>
  </main>

  <main id="view-backup" hidden>
    <section class="card">
      <h2>Backup / Restore</h2>
      <div class="muted">Backup do app (cat√°logo, lista, hist√≥rico e pre√ßos) + export CSV.</div>
      <div class="sep"></div>

      <div class="btns">
        <button type="button" class="primary" id="btnExportPurchases">Exportar compras (.csv)</button>
        <button type="button" class="primary" id="btnExportPrices">Exportar pre√ßos (.csv)</button>
      </div>

      <div class="sep"></div>

      <div class="grid2">
        <div class="card" style="padding:12px">
          <h2>Backup</h2>
          <div class="muted">Baixar .json ou copiar o texto.</div>
          <div class="sep"></div>
          <div class="btns">
            <button type="button" class="primary" id="btnDownloadBackup">Baixar backup (.json)</button>
            <button type="button" id="btnCopyBackup">Copiar backup</button>
          </div>
          <div class="sep"></div>
          <textarea id="backupText" readonly></textarea>
        </div>

        <div class="card" style="padding:12px">
          <h2>Restore</h2>
          <div class="muted">Importe um backup .json (ou cole o texto).</div>
          <div class="sep"></div>
          <div class="field">
            <label>Importar arquivo</label>
            <input id="jsonImport" type="file" accept=".json,application/json" />
          </div>
          <div class="sep"></div>
          <div class="field">
            <label>Colar backup</label>
            <textarea id="restoreText" placeholder="Cole aqui o conte√∫do do backup e clique em Restaurar"></textarea>
          </div>
          <div class="btns">
            <button type="button" class="warn" id="btnRestoreText">Restaurar</button>
            <button type="button" class="danger" id="btnHardReset">Resetar tudo</button>
          </div>
        </div>
      </div>

      <div class="sep"></div>
      <details>
        <summary>Diagn√≥stico</summary>
        <div class="tiny" id="debugBox" style="margin-top:10px; white-space:pre-wrap; font-family:var(--mono)"></div>
      </details>
    </section>
  </main>
</div>

<div class="bottomNav">
  <div class="navRow">
    <button type="button" class="navBtn active" data-tab="mercado">‚ö° Mercado</button>
    <button type="button" class="navBtn" data-tab="catalogo">üì¶ Cat√°logo</button>
    <button type="button" class="navBtn" data-tab="historico">üßæ Hist√≥rico</button>
    <button type="button" class="navBtn" data-tab="backup">üíæ Backup</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const SEED_PRODUCTS = [{"nome": "PAPEL HIG DUETTO F", "preco": 18.99}, {"nome": "MELANCIA", "preco": 2.49}, {"nome": "ALVEJANTE QUIMARE", "preco": 11.99}, {"nome": "DESINFETANTE GRAN", "preco": 9.69}, {"nome": "ALVEJANTE GIRANDO", "preco": 8.39}, {"nome": "DETERGENTE ODD 500", "preco": 2.89}, {"nome": "FIXADOR KARINA 400", "preco": 29.99}, {"nome": "GEL DENTAL COLGATE", "preco": 10.99}, {"nome": "DESOD REXONA ROLL-ON", "preco": 9.99}, {"nome": "TOALHA DE PAPEL", "preco": 3.99}, {"nome": "LA DE ACO BOMBRIL", "preco": 2.99}, {"nome": "REFRIGERANTE COCA (pack 12)", "preco": 1.99}, {"nome": "REFRIGERANTE COCA", "preco": 11.99}, {"nome": "ABS INTIMUS TRIPLA", "preco": 7.99}, {"nome": "OLEO DE SOJA COAMO", "preco": 7.99}, {"nome": "FILTRO BRIGITTA 10", "preco": 3.99}, {"nome": "INSETICIDA SBP 12", "preco": 12.99}, {"nome": "HASTES FLEXIVEIS", "preco": 3.49}, {"nome": "SABONETE NIVEA 85G", "preco": 3.49}, {"nome": "BATATA PALHA KI", "preco": 3.49}, {"nome": "MACARRAO NISSIN", "preco": 3.29}, {"nome": "CHOCOLATE LACTA 80G", "preco": 7.99}, {"nome": "BATATA SLICE 90G", "preco": 8.59}, {"nome": "SALGADINHO PIPOTEC", "preco": 2.99}, {"nome": "MOLHO TOMATE POMAR", "preco": 4.69}, {"nome": "MILHO VERDE PREDILECTA", "preco": 3.49}, {"nome": "CHA MATTE LEAO SAQ", "preco": 4.79}, {"nome": "CHOCOLATE LACTA BIS", "preco": 4.95}, {"nome": "CATCHUP HELLMANN'S 320G", "preco": 6.99}, {"nome": "PIPOCA MICRO YOKI", "preco": 3.99}, {"nome": "GELADINHO AMERICAN", "preco": 12.99}, {"nome": "CERVEJA AMSTEL LAGER", "preco": 2.99}, {"nome": "LEITE LONGA VIDA", "preco": 3.49}, {"nome": "LEITE CONDENSADO", "preco": 3.99}, {"nome": "CREME DE LEITE PIRACANJUBA", "preco": 3.29}, {"nome": "BISC PASSA TEMPO", "preco": 3.89}, {"nome": "REFRESCO MAGRO 8G", "preco": 1.39}, {"nome": "IOGURTE GRAO PENSE", "preco": 3.29}, {"nome": "IOGURTE FRUTAP DESSERT", "preco": 0.99}, {"nome": "BANANA CATURRA", "preco": 1.97}, {"nome": "LINGUICA SPITZNER", "preco": 49.99}, {"nome": "CARNE BOVINA P/ STROGONOFF", "preco": 54.99}, {"nome": "CARNE BOVINA PATINHO", "preco": 54.99}, {"nome": "CARNE BOVINA MOIDA", "preco": 49.99}, {"nome": "KIT SALADA MIG", "preco": 13.98}, {"nome": "BATATA CONG COPACO", "preco": 9.59}, {"nome": "ISCAS DE FRANGO", "preco": 8.99}, {"nome": "FRANGO FILE", "preco": 23.99}, {"nome": "MANGA PALMER", "preco": 4.49}, {"nome": "FERMENTO QUIMICO", "preco": 4.99}, {"nome": "SALSINHA PICADA", "preco": 2.99}, {"nome": "PAO FRANCES", "preco": 12.98}, {"nome": "SANDUICHE NATURAL", "preco": 49.99}, {"nome": "PALITO DE QUEIJO", "preco": 1.0}, {"nome": "BATATA ONDA KARINA", "preco": 9.97}];
const $ = (id)=>document.getElementById(id);
const norm = (s)=>String(s||"").trim();
const normKey = (s)=>norm(s).toUpperCase();
function money(v){ return "R$ " + (Number.isFinite(Number(v)) ? Number(v) : 0).toFixed(2).replace(".", ","); }
function uid(){ return Math.random().toString(16).slice(2)+Date.now().toString(16); }
function todayISO(){ const d=new Date(); const z=new Date(d.getTime() - d.getTimezoneOffset()*60000); return z.toISOString().slice(0,10); }
function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }
function toast(msg){ const el=$("toast"); el.innerHTML=msg; el.classList.add("show"); clearTimeout(toast._t); toast._t=setTimeout(()=>el.classList.remove("show"), 1800); }
function parseBRMoney(str){ if(str==null) return NaN; const s=String(str).trim().replace(/\s/g,""); if(!s) return NaN; const cleaned=s.replace(/\.(?=\d{3}(\D|$))/g,"").replace(",","."); const v=Number(cleaned); return Number.isFinite(v)?v:NaN; }
function parsePriceAny(v){ if(typeof v==="number") return Number.isFinite(v)?v:0; const n=parseBRMoney(v); return Number.isFinite(n)?n:0; }
function csvEscape(s){ s=String(s??""); if(/[",\n\r;]/.test(s)) return '"' + s.replaceAll('"','""') + '"'; return s; }
function downloadText(filename, text, mime="text/plain"){ const blob=new Blob([text], {type:mime}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

const KEY = "shopping_price_app_stable_1_2_4_4";
const LEGACY_KEYS = ["shopping_price_app_stable_1_2_4_4_2","shopping_price_app_stable_1_2_4_4_1","shopping_price_app_stable_1_2_4_4"];
let LAST_ERROR = "";
let state = null;
let selectedNameKey = "";
let histMode = "all"; // all | store

function seedCatalog(){ const m=new Map(); for(const p of SEED_PRODUCTS){ const key=normKey(p.nome); if(!key) continue; if(!m.has(key)) m.set(key, {id:uid(), nome:norm(p.nome), preco:parsePriceAny(p.preco)}); } return Array.from(m.values()); }
function makeEmptyCurrent(){ return { id:uid(), date:todayISO(), store:"", items:[] }; }
function normalizeState(st){ st=st||{}; st.catalog=Array.isArray(st.catalog)?st.catalog:seedCatalog(); for(const p of st.catalog) p.preco=parsePriceAny(p.preco); st.autoSum=(st.autoSum!==false); st.updateCatalogOnEdit=!!st.updateCatalogOnEdit; st.current=st.current||makeEmptyCurrent(); st.current.date=st.current.date||todayISO(); st.current.store=st.current.store||""; st.current.items=Array.isArray(st.current.items)?st.current.items:[]; for(const it of st.current.items){ it.price=parsePriceAny(it.price); it.qty=Number.isFinite(Number(it.qty))?Number(it.qty):1; it.checked=(it.checked!==false); it.name=it.name||it.nome||""; it.saveToCatalog=!!it.saveToCatalog; } st.purchases=Array.isArray(st.purchases)?st.purchases:[]; st.priceHistory=(st.priceHistory && typeof st.priceHistory==="object")?st.priceHistory:{}; return st; }
function load(){
  // tenta chave atual, sen√£o migra de vers√µes anteriores
  const tryKeys = [KEY].concat((Array.isArray(LEGACY_KEYS)?LEGACY_KEYS:[]));
  for(const k of tryKeys){
    const raw = localStorage.getItem(k);
    if(!raw) continue;
    try{
      const st = normalizeState(JSON.parse(raw));
      // migra para KEY atual
      localStorage.setItem(KEY, JSON.stringify(st));
      if(k!==KEY) localStorage.removeItem(k);
      return st;
    }catch(e){}
  }
  const st = normalizeState({});
  localStorage.setItem(KEY, JSON.stringify(st));
  return st;
}
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

function syncChips(){ $("chipCatalogo").textContent="Cat√°logo: "+(state.catalog?.length||0); $("chipItens").textContent="Itens: "+(state.current?.items?.length||0); $("chipCompras").textContent="Compras: "+(state.purchases?.length||0); $("chipAuto").textContent="Auto-soma: "+(state.autoSum?"ON":"OFF"); }
function computeTotal(){
  return (state.current.items||[]).reduce((acc,it)=>{
    if(!it || !it.checked) return acc;
    const price = (it._priceDraft!=null) ? parsePriceAny(it._priceDraft) : Number(it.price);
    const qty = Number(it.qty);
    const line = price * qty;
    return acc + (Number.isFinite(line) ? line : 0);
  }, 0);
}
function renderTotal(){ const total=computeTotal(); $("totalNow").textContent=money(total); const marked=(state.current.items||[]).filter(x=>x.checked).length; $("totalSmall").textContent=marked+" marcados / "+(state.current.items||[]).length+" itens"; }

function findMatches(q){ q=normKey(q); if(!q) return []; const a=[],b=[]; for(const p of state.catalog){ const k=normKey(p.nome); if(k.startsWith(q)) a.push(p); else if(k.includes(q)) b.push(p); } return a.concat(b).slice(0,12); }
function renderMatches(){ const matches=findMatches($("searchCatalog").value); $("matchBox").innerHTML=matches.map(p=>`
  <div class="item" data-act="add" data-pid="${p.id}" style="cursor:pointer">
    <div class="grow">
      <div class="name">${escapeHtml(p.nome)}</div>
      <div class="meta">Pre√ßo: <span class="pill price">${money(p.preco)}</span></div>
    </div>
    <button type="button" class="primary" data-act="add" data-pid="${p.id}">+ Add</button>
  </div>
`).join("") || `<div class="muted">Digite para buscar‚Ä¶</div>`; }

function renderList(){ $("currentList").innerHTML=(state.current.items||[]).map(it=>`
  <div class="item">
    <input type="checkbox" data-act="toggle" data-id="${it.id}" ${it.checked?"checked":""} style="margin-top:4px; width:20px; height:20px"/>
    <div class="grow">
      <div class="name" style="cursor:pointer" data-act="pick" data-id="${it.id}">${escapeHtml(it.name)}</div>
      <div class="meta">
        Qtd:
        <input data-act="qty" data-id="${it.id}" type="number" min="1" step="1" value="${it.qty}" style="width:90px; margin-left:6px"/>
        &nbsp;|&nbsp; Pre√ßo:
        <input data-act="price" data-id="${it.id}" inputmode="decimal" value="${(it._priceDraft!=null? String(it._priceDraft) : String(Number(it.price||0).toFixed(2)).replace(".", ","))}" style="width:120px; margin-left:6px"/>
        <span class="pill" style="margin-left:8px">Parcial: ${money(Number(it.price)*Number(it.qty))}</span>
        <span class="switch" style="margin-left:10px">
          <input data-act="savecat" data-id="${it.id}" type="checkbox" ${it.saveToCatalog?"checked":""}/>
          <span>salvar no cat√°logo</span>
        </span>
      </div>
    </div>
    <div class="btns">
      <button type="button" class="danger" data-act="remove" data-id="${it.id}">Remover</button>
    </div>
  </div>
`).join("") || `<div class="muted">Nenhum item na lista.</div>`; syncChips(); renderTotal(); }

function updateCatalogPriceForItem(it){ const price=Number(parsePriceAny(it.price)); if(!Number.isFinite(price)) return; // by productId first
  let p=null;
  if(it.productId) p=state.catalog.find(x=>x.id===it.productId);
  if(!p){ const key=normKey(it.name); p=state.catalog.find(x=>normKey(x.nome)===key); }


function upsertCatalogProduct(nome, preco){
  nome = norm(nome);
  const key = normKey(nome);
  if(!key) return null;
  preco = Number(parsePriceAny(preco));
  let p = state.catalog.find(x=>normKey(x.nome)===key);
  if(p){
    p.preco = preco;
    save();
    return p;
  }
  p = { id: uid(), nome, preco };
  state.catalog.unshift(p);
  save();
  return p;
}

function addCustomProductFlow(addToList){
  const nome = norm($("quickName").value);
  const precoRaw = $("quickPrice").value;
  if(!nome) return alert("Digite o nome do produto.");
  const preco = parsePriceAny(precoRaw);
  if(!(preco > 0)) return alert("Digite um valor v√°lido (ex.: 12,90).");
  const p = upsertCatalogProduct(nome, preco);
  if(!p) return;
  $("quickName").value = "";
  $("quickPrice").value = "";
  renderMatches();
  renderCatalog();
  syncChips();
  updateBackupBox();
  renderDebug();
  toast("Produto salvo no <b>cat√°logo</b>.");
  if(addToList){
    addFromCatalog(p.id);
  }
}
  if(p){ p.preco=price; } }

function addFromCatalog(pid){ const p=state.catalog.find(x=>x.id===pid); if(!p) return; const it={id:uid(), productId:p.id, name:p.nome, price:parsePriceAny(p.preco), qty:1, checked: state.autoSum, saveToCatalog:false}; state.current.items.unshift(it); state.current.date=$("buyDate").value || state.current.date || todayISO(); state.current.store=$("buyStore").value || state.current.store || ""; save(); renderList(); toast(`Adicionado: <b>${escapeHtml(p.nome)}</b>`); }

function addPriceHistoryForItem(it, date, store){ const key=normKey(it.name); if(!key) return; const arr=Array.isArray(state.priceHistory[key])?state.priceHistory[key]:[]; arr.push({date, store, price:Number(parsePriceAny(it.price))}); state.priceHistory[key]=arr.slice(-80); }

function renderPriceHistory(){ if(!selectedNameKey) return; const storeNow=norm($("buyStore").value)||norm(state.current.store)||""; let arr=Array.isArray(state.priceHistory[selectedNameKey])?state.priceHistory[selectedNameKey]:[]; const allArr=arr;
  if(histMode==="store" && storeNow) arr=arr.filter(r=>normKey(r.store)===normKey(storeNow));
  if(!arr.length){ $("phTitle").textContent = histMode==="store" ? "Sem hist√≥rico deste produto neste mercado ainda." : "Sem hist√≥rico para este produto ainda. Finalize uma compra para registrar."; $("phBox").innerHTML=""; return; }
  const prices=arr.map(x=>Number(x.price)).filter(x=>Number.isFinite(x));
  const min=Math.min(...prices), max=Math.max(...prices);
  const last=arr[arr.length-1];
  // last price in store
  let lastStoreText="";
  if(storeNow){ const storeRecs=allArr.filter(r=>normKey(r.store)===normKey(storeNow)); if(storeRecs.length){ const ls=storeRecs[storeRecs.length-1]; lastStoreText = " ‚Ä¢ √∫ltimo neste mercado: "+money(ls.price); } }
  $("phTitle").textContent = "Produto: "+selectedNameKey+" ‚Äî m√≠n "+money(min)+" | m√°x "+money(max)+" | √∫ltimo "+money(last.price)+lastStoreText;
  const lastOnes=arr.slice(-12).reverse();
  $("phBox").innerHTML=lastOnes.map(r=>`
    <div class="item">
      <div class="grow">
        <div class="name">${escapeHtml(r.store || "‚Äî")}</div>
        <div class="meta">${escapeHtml(r.date)} ‚Ä¢ <span class="pill price">${money(r.price)}</span></div>
      </div>
    </div>
  `).join("");
}

function renderPurchases(){ const list=(state.purchases||[]).slice().reverse(); if(!list.length){ $("purchasesList").innerHTML=`<div class="muted">Nenhuma compra finalizada ainda.</div>`; return; } $("purchasesList").innerHTML=list.map(p=>`
  <details>
    <summary>${escapeHtml(p.date)} ‚Ä¢ ${escapeHtml(p.store)} ‚Ä¢ <span class="pill price">${money(p.total)}</span> ‚Ä¢ ${p.items.length} itens</summary>
    <div class="sep"></div>
    <div class="list">
      ${
        p.items.map(it=>`
          <div class="item">
            <div class="grow">
              <div class="name">${escapeHtml(it.name)}</div>
              <div class="meta">Qtd: ${it.qty} ‚Ä¢ Unit: <span class="pill price">${money(it.price)}</span> ‚Ä¢ Parcial: <span class="pill">${money(it.price*it.qty)}</span></div>
            </div>
          </div>
        `).join("")
      }
    </div>
  </details>
`).join(""); }

function renderCatalog(){ const q=normKey($("catSearch").value); const list=(state.catalog||[]).filter(p=>!q || normKey(p.nome).includes(q)).slice(0,250); $("catalogList").innerHTML=list.map(p=>`
  <div class="item">
    <div class="grow">
      <div class="name">${escapeHtml(p.nome)}</div>
      <div class="meta"><span class="pill price">${money(p.preco)}</span></div>
    </div>
  </div>
`).join("") || `<div class="muted">Cat√°logo vazio.</div>`; }

function buildBackupText(){ return JSON.stringify({version:"stable 1.2.4.4.3", exportedAt:new Date().toISOString(), data: state}); }
function updateBackupBox(){ $("backupText").value = buildBackupText(); }

function applyRestoreText(text){ const obj=JSON.parse(text); const data=obj.data?obj.data:obj; state=normalizeState(data); save(); $("buyDate").value=state.current.date||todayISO(); $("buyStore").value=state.current.store||""; $("toggleUpdateCatalog").checked=!!state.updateCatalogOnEdit; renderMatches(); renderList(); renderPurchases(); renderCatalog(); syncChips(); updateBackupBox(); renderDebug(); renderPriceHistory(); toast("Restore conclu√≠do."); }

function exportPurchasesCSV(){ const rows=[]; rows.push(["compra_id","data","estabelecimento","total_compra","produto","qtd","preco_unit","parcial"].join(";")); for(const p of (state.purchases||[])){ for(const it of (p.items||[])){ const parcial=Number(it.price)*Number(it.qty); rows.push([csvEscape(p.id),csvEscape(p.date),csvEscape(p.store),String(p.total).replace(".",","),csvEscape(it.name),String(it.qty),String(it.price).replace(".",","),String(parcial).replace(".",",")].join(";")); } } const text=rows.join("\n"); downloadText("compras.csv", text, "text/csv;charset=utf-8"); }
function exportPricesCSV(){ const rows=[]; rows.push(["produto","data","estabelecimento","preco"].join(";")); const keys=Object.keys(state.priceHistory||{}); for(const k of keys){ const arr=state.priceHistory[k]||[]; for(const r of arr){ rows.push([csvEscape(k),csvEscape(r.date),csvEscape(r.store||""),String(r.price).replace(".",",")].join(";")); } } const text=rows.join("\n"); downloadText("precos.csv", text, "text/csv;charset=utf-8"); }

function renderDebug(){ const dbg={versao:"stable 1.2.4.4.3", catalogo:state.catalog?.length||0, itens:state.current?.items?.length||0, compras:state.purchases?.length||0, total:computeTotal(), histMode, lastError:LAST_ERROR||"-"}; $("debugBox").textContent=JSON.stringify(dbg,null,2); }

function showTab(tab){ document.querySelectorAll(".navBtn").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab)); $("view-mercado").hidden=(tab!=="mercado"); $("view-catalogo").hidden=(tab!=="catalogo"); $("view-historico").hidden=(tab!=="historico"); $("view-backup").hidden=(tab!=="backup"); if(tab==="catalogo") renderCatalog(); if(tab==="historico") renderPurchases(); if(tab==="backup") updateBackupBox(); }

window.addEventListener("error", (e)=>{ LAST_ERROR=(e?.message||"")+" @"+(e?.filename||"")+"#"+(e?.lineno||""); try{renderDebug();}catch(_){} });
window.addEventListener("unhandledrejection", (e)=>{ LAST_ERROR="Promise: "+(e?.reason?.message||e?.reason||""); try{renderDebug();}catch(_){} });

document.addEventListener("DOMContentLoaded", ()=>{
  state = load();
  $("buyDate").value = state.current.date || todayISO();
  $("buyStore").value = state.current.store || "";
  $("toggleUpdateCatalog").checked = !!state.updateCatalogOnEdit;

  syncChips();
  renderMatches();
  renderList();
  renderPurchases();
  updateBackupBox();
  renderDebug();

  document.querySelectorAll(".navBtn").forEach(btn=>btn.addEventListener("click", ()=>showTab(btn.dataset.tab)));

  $("searchCatalog").addEventListener("input", ()=>renderMatches());
  $("catSearch").addEventListener("input", ()=>renderCatalog());
  $("buyDate").addEventListener("change", ()=>{ state.current.date=$("buyDate").value; save(); renderDebug(); updateBackupBox(); });
  $("buyStore").addEventListener("input", ()=>{ state.current.store=$("buyStore").value; save(); renderDebug(); updateBackupBox(); renderPriceHistory(); });

  $("toggleUpdateCatalog").addEventListener("change", ()=>{ state.updateCatalogOnEdit = $("toggleUpdateCatalog").checked; save(); toast("Atualizar cat√°logo: <b>"+(state.updateCatalogOnEdit?"ON":"OFF")+"</b>"); updateBackupBox(); renderDebug(); });

  
  // Cadastro r√°pido de produto (click + touch)
  (function(){
    const b1 = $("btnQuickAddCatalog");
    const b2 = $("btnQuickAddList");
    function bind(btn, addToList){
      if(!btn) return;
      const handler = (e)=>{
        try{ if(e && e.cancelable) e.preventDefault(); }catch(_){ }
        try{ toast("Processando‚Ä¶"); }catch(_){ }
        addCustomProductFlow(addToList);
      };
      btn.addEventListener("click", handler, {passive:false});
      btn.addEventListener("touchend", handler, {passive:false});
    }
    bind(b1, false);
    bind(b2, true);
  })();
// history filter buttons
  function setHistMode(mode){
    histMode = mode;
    $("btnHistAll").classList.toggle("active", mode==="all");
    $("btnHistStore").classList.toggle("active", mode==="store");
    renderPriceHistory();
    renderDebug();
  }
  $("btnHistAll").addEventListener("click", ()=>setHistMode("all"));
  $("btnHistStore").addEventListener("click", ()=>setHistMode("store"));
  setHistMode("all");

  // Add handler (stable)
  (function(){
    const box = $("matchBox");
    let last = 0;
    function onTap(e){
      const t = e.target?.closest?.("[data-act='add']");
      if(!t) return;
      if(e.cancelable) e.preventDefault();
      const now = Date.now();
      if(now - last < 250) return;
      last = now;
      const pid = t.dataset.pid;
      if(pid) addFromCatalog(pid);
      try{ $("searchCatalog").value=""; $("searchCatalog").blur(); }catch(_){}
      renderMatches();
      renderDebug();
      updateBackupBox();
    }
    box.addEventListener("click", onTap, {passive:false});
    box.addEventListener("touchend", onTap, {passive:false});
  })();

  // List interactions
  $("currentList").addEventListener("input", (e)=>{
    // FIX (Samsung/mobile): n√£o re-renderizar a lista a cada tecla,
    // sen√£o o campo "Pre√ßo" volta o valor e parece que n√£o altera.
    const t = e.target;
    const id = t.dataset.id;
    if(!id) return;
    const it = state.current.items.find(x=>x.id===id);
    if(!it) return;

    if(t.dataset.act==="qty"){
      it.qty = Math.max(1, Number(t.value)||1);
      save();
      renderTotal();
      renderDebug();
      updateBackupBox();
      return;
    }

    if(t.dataset.act==="price"){
      // Enquanto digita, guardamos o texto cru para n√£o "formatar" e atrapalhar.
      it._priceDraft = String(t.value ?? "");
      save();
      renderTotal();
      renderDebug();
      updateBackupBox();
      return;
    }
  });

$("currentList").addEventListener("change", (e)=>{
    const t = e.target;
    const id = t.dataset.id;
    if(!id) return;
    const it = state.current.items.find(x=>x.id===id);
    if(!it) return;

    if(t.dataset.act==="toggle"){
      it.checked = !!t.checked;
      save(); renderList(); renderDebug(); updateBackupBox();
      return;
    }

    if(t.dataset.act==="savecat"){
      it.saveToCatalog = !!t.checked;
      save(); renderList(); renderDebug(); updateBackupBox();
      return;
    }

    if(t.dataset.act==="qty"){
      it.qty = Math.max(1, Number(t.value)||1);
      save(); renderList(); renderDebug(); updateBackupBox();
      return;
    }

    if(t.dataset.act==="price"){
      const raw = (it._priceDraft != null) ? it._priceDraft : t.value;
      it.price = parsePriceAny(raw);
      it._priceDraft = null;

      // Atualiza cat√°logo apenas se global+item estiverem ligados
      if(state.updateCatalogOnEdit && it.saveToCatalog){
        updateCatalogPriceForItem(it);
        toast("Pre√ßo salvo no <b>cat√°logo</b>.");
      }

      save(); renderList(); renderDebug(); updateBackupBox();
      return;
    }
  });

$("currentList").addEventListener("click", (e)=>{
    const pick = e.target?.closest?.("[data-act='pick']");
    if(pick){
      const it = state.current.items.find(x=>x.id===pick.dataset.id);
      if(it){ selectedNameKey = normKey(it.name); renderPriceHistory(); }
      return;
    }
    const rm = e.target?.closest?.("[data-act='remove']");
    if(!rm) return;
    state.current.items = state.current.items.filter(x=>x.id!==rm.dataset.id);
    save(); renderList(); renderDebug(); updateBackupBox();
  });

  $("btnToggleAuto").addEventListener("click", ()=>{ state.autoSum = !state.autoSum; save(); syncChips(); renderDebug(); updateBackupBox(); toast("Auto-soma: <b>"+(state.autoSum?"ON":"OFF")+"</b>"); });

  $("btnLimpar").addEventListener("click", ()=>{
    if(!confirm("Limpar a compra atual?")) return;
    state.current = makeEmptyCurrent();
    state.current.date = $("buyDate").value || todayISO();
    state.current.store = $("buyStore").value || "";
    save(); renderList(); renderDebug(); updateBackupBox(); toast("Compra limpa.");
  });

  $("btnFinalizar").addEventListener("click", ()=>{
    const store = norm($("buyStore").value);
    const date = $("buyDate").value || todayISO();
    if(!store) return alert("Informe o estabelecimento.");
    if(!state.current.items.length) return alert("Adicione itens.");
    const total = computeTotal();

    // Confirma pre√ßos digitados (draft) antes de finalizar
    for(const it of state.current.items){
      if(it && it._priceDraft!=null){
        it.price = parsePriceAny(it._priceDraft);
        it._priceDraft = null;
      }
    }
    const items = state.current.items.map(it=>({
      name: it.name,
      qty: Number(it.qty)||1,
      price: Number(parsePriceAny(it.price))
    }));

    for(const it of items) addPriceHistoryForItem(it, date, store);

    state.purchases.push({ id:uid(), date, store, total, items });
    state.purchases = state.purchases.slice(-250);

    state.current = makeEmptyCurrent();
    state.current.date = date;
    state.current.store = store;

    save();
    renderList();
    renderPurchases();
    syncChips();
    renderTotal();
    updateBackupBox();
    renderDebug();
    renderPriceHistory();
    toast("Compra salva no hist√≥rico.");
  });

  // Backup
  $("btnDownloadBackup").addEventListener("click", ()=>{ downloadText("lista-compras-backup-"+new Date().toISOString().slice(0,10)+".json", buildBackupText(), "application/json"); });
  $("btnCopyBackup").addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(buildBackupText()); toast("Backup copiado."); }
    catch(e){ $("backupText").focus(); $("backupText").select(); toast("Selecione e copie manualmente."); }
  });

  // Restore file
  $("jsonImport").addEventListener("change", async ()=>{
    const f = $("jsonImport").files?.[0];
    if(!f) return;
    try{ applyRestoreText(await f.text()); }
    catch(err){ alert("Falha no restore: "+(err.message||err)); LAST_ERROR=String(err.message||err); renderDebug(); }
    finally{ $("jsonImport").value=""; }
  });

  // Restore paste
  $("btnRestoreText").addEventListener("click", ()=>{
    const text = $("restoreText").value.trim();
    if(!text) return alert("Cole o backup primeiro.");
    if(!confirm("Restaurar vai substituir os dados atuais. Continuar?")) return;
    try{ applyRestoreText(text); }
    catch(err){ alert("Falha no restore: "+(err.message||err)); LAST_ERROR=String(err.message||err); renderDebug(); }
  });

  // Hard reset
  $("btnHardReset").addEventListener("click", ()=>{
    if(!confirm("Resetar tudo? (apaga lista, hist√≥rico e pre√ßos)")) return;
    localStorage.removeItem(KEY);
    state = load();
    $("buyDate").value = state.current.date || todayISO();
    $("buyStore").value = state.current.store || "";
    $("toggleUpdateCatalog").checked = !!state.updateCatalogOnEdit;
    selectedNameKey = "";
    $("phBox").innerHTML = "";
    $("phTitle").textContent = "Toque no nome do item da lista para ver m√≠nimo/m√°ximo e √∫ltimos registros.";
    syncChips(); renderMatches(); renderList(); renderPurchases(); updateBackupBox(); renderDebug();
    toast("Reset conclu√≠do.");
  });

  // CSV import
  $("csvImport").addEventListener("change", async ()=>{
    const f = $("csvImport").files?.[0];
    if(!f) return;
    try{
      const text = await f.text();
      const rows = text.split(/\r?\n/).filter(Boolean);
      const header = rows.shift().split(/;|,/).map(x=>x.trim().toLowerCase());
      const iProd = header.indexOf("produto");
      const iVal = header.indexOf("valor_unitario");
      if(iProd<0 || iVal<0) throw new Error("CSV precisa ter colunas: produto;valor_unitario");
      const m = new Map((state.catalog||[]).map(p=>[normKey(p.nome), p]));
      for(const row of rows){
        const cols = row.split(/;|,/);
        const nome = norm(cols[iProd]);
        const preco = parsePriceAny(cols[iVal]);
        if(!nome) continue;
        const key = normKey(nome);
        if(!m.has(key)) m.set(key, {id:uid(), nome, preco});
      }
      state.catalog = Array.from(m.values());
      save(); syncChips(); renderCatalog(); renderMatches(); updateBackupBox(); renderDebug();
      toast("CSV importado.");
    }catch(err){
      alert("Falha ao importar CSV: " + (err.message||err));
      LAST_ERROR = String(err.message||err);
      renderDebug();
    }finally{ $("csvImport").value = ""; }
  });

  // exports
  $("btnExportPurchases").addEventListener("click", exportPurchasesCSV);
  $("btnExportPrices").addEventListener("click", exportPricesCSV);

});
</script>
</body>
</html>
